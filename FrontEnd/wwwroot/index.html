<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>FlyingPizza</title>
    <base href="/"/>
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/app.css" rel="stylesheet"/>
    <link href="FrontEnd.styles.css" rel="stylesheet"/>

    <link rel="stylesheet" href="_content/Radzen.Blazor/css/default-base.css">
</head>

<body>
<script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABM05Ov28GgnvCE6fvNUT0hmPB7Ol6kuI&callback=initMap">
</script>
<script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>
<div id="app">Loading...</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>
<script src="_framework/blazor.webassembly.js"></script>

<script>
    var map
    let markers = {}

    
    function initGoogleMap(obj) {
        map = new google.maps.Map(document.getElementById("map"), {
            center: {lat: obj.lat, lng: obj.lng},
            zoom: 12,
        });

    }

    function addMarker(id, newMarker) {
        var marker = new google.maps.Marker({
            position: {lat: newMarker["lat"], lng: newMarker["lng"]},
            title: id
        });

        // To add the marker to the map, call setMap();
        markers[id] = marker;
        marker.setMap(map);
    }
    
    function getMarkers() {
        return markers;
    }
    
    function collectionContains(collection, x) {
        collection.forEach(y => {
           if (y === x){
               return true;
           }
       })
        return false;
    }
    
    function updateAll(_temp){
        for(key in markers){ // find out which markers are deleted, remove them
            if(!(key in _temp)){
                console.log(key + " is no longer a valid markers! removing " + markers[key])
            }
        }
        for(var thing in _temp) { 
            if(!(thing in markers)){ // find out which are new, add them
                console.log(thing + " is not in known markers! inserting {" + _temp[thing])
                addMarker(thing, _temp[thing])
            } else { // must check if the marker is in a new location
                newMarker = _temp[thing]
                if(
                    newMarker["lat"] !== markers[thing].lat ||
                    newMarker["lng"] !== markers[thing].lng
                ){
                    console.log("drone " + thing + " has moved!")
                    updateMarker(thing,  newMarker["lat"],  newMarker["lng"])
                }
            }
        }
    }
    
    function removeMarker(id){
        markers[id].setMap(null)
        delete markers[id]
    }
    
    function removeAllMarkers(){
        for (let i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = []
    }
   
    
    function updateMarker(id, lat, lng){
        markers[id].setMap(map)
        markers[id].setPosition(new google.maps.LatLng(lat, lng))
    }

    window.initMap = initMap;
</script>
</body>

</html>
